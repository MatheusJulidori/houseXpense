name: houseXpense

services:
    postgres:
        image: postgres:18-alpine
        container_name: ${COMPOSE_PROJECT_NAME:-housexpense}_postgres
        restart: unless-stopped
        labels:
            com.housexpense.project: houseXpense
            com.housexpense.service: postgres
        environment:
            POSTGRES_DB: ${POSTGRES_DB}
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}",
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        networks:
            - internal

    backend:
        build:
            context: ../server
            dockerfile: Dockerfile
            target: production
        image: ${BACKEND_IMAGE:-housexpense-backend}
        container_name: ${COMPOSE_PROJECT_NAME:-housexpense}_backend
        depends_on:
            postgres:
                condition: service_healthy
        restart: unless-stopped
        labels:
            com.housexpense.project: houseXpense
            com.housexpense.service: backend
        env_file:
            - ../.env
        environment:
            NODE_ENV: ${NODE_ENV:-production}
            PORT: ${SERVER_PORT:-3000}
            DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:${POSTGRES_PORT:-5432}/${POSTGRES_DB}
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRE: ${JWT_EXPIRE:-24h}
            LOG_LEVEL: ${BACKEND_LOG_LEVEL:-info}
        ports:
            - "${SERVER_PORT:-3000}:3000"
        healthcheck:
            test:
                ["CMD", "curl", "-f", "http://localhost:3000/api/health/ready"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 15s
        security_opt:
            - no-new-privileges:true
        read_only: true
        tmpfs:
            - /tmp
        networks:
            - internal

    frontend:
        build:
            context: ../frontend
            dockerfile: Dockerfile
            args:
                VITE_API_URL: ${VITE_API_URL:-http://localhost:3000/api}
                VITE_APP_NAME: ${VITE_APP_NAME:-houseXpense}
                VITE_APP_VERSION: ${VITE_APP_VERSION:-1.0.0}
            target: production
        image: ${FRONTEND_IMAGE:-housexpense-frontend}
        container_name: ${COMPOSE_PROJECT_NAME:-housexpense}_frontend
        depends_on:
            backend:
                condition: service_healthy
        restart: unless-stopped
        labels:
            com.housexpense.project: houseXpense
            com.housexpense.service: frontend
        ports:
            - "${FRONTEND_PORT:-5173}:80"
        security_opt:
            - no-new-privileges:true
        read_only: true
        tmpfs:
            - /var/cache/nginx
            - /var/run
            - /var/log/nginx
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "wget --no-verbose --spider http://localhost/ || exit 1",
                ]
            interval: 30s
            timeout: 5s
            retries: 3
            start_period: 10s
        networks:
            - internal

networks:
    internal:
        name: housexpense_internal
        driver: bridge
        labels:
            com.housexpense.project: houseXpense
            com.housexpense.network: internal

volumes:
    postgres_data:
        name: housexpense_postgres_data
        driver: local
        labels:
            com.housexpense.project: houseXpense
            com.housexpense.volume: postgres_data
